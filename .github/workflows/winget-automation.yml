name: WinGet Automation
on:
  schedule:
    - cron: '11 * * * *'
  workflow_dispatch:
  pull_request_target:
    branches: main
    paths: Formula/**
concurrency:
  group: winget-automation-${{ github.event.pull_request.number || 'scheduled' }}
  # only cancel when a run is triggered by a pull request (when a commit is pushed on the PR)
  # else do not cancel the previous run if it's a scheduled or workflow_dispatch run
  cancel-in-progress: ${{ github.event_name == 'pull_request_target' }}
jobs:
  build:
    runs-on: windows-latest
    steps:
      - if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        name: Checkout repository üì•
        uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false

      - if: github.event_name == 'pull_request_target'
        name: Checkout pull request üëã
        uses: actions/checkout@v4.2.2
        with:
          persist-credentials: false
          ref: ${{ github.event.pull_request.head.sha }}

      - run: Install-PSResource -Name powershell-yaml -Scope CurrentUser -Repository PSGallery -TrustRepository

      - if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        name: Setup git user and email üôã‚Äç‚ôÇÔ∏è
        run: |
          git config --local user.name 'vedantmgoyal-bot[bot]'
          git config --local user.email '110876359+vedantmgoyal-bot[bot]@users.noreply.github.com'

      - if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: .\WinGetAutomation.ps1
        env:
          BOT_PVT_KEY: ${{ secrets.BOT_PRIVATE_KEY }}
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_INST_ID: ${{ secrets.BOT_INST_ID }}
          WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - if: github.event_name == 'pull_request_target'
        uses: tj-actions/changed-files@v46
        with:
          files: Formula/**/*.json
          json: true
          escape_json: false
        id: changed-files

      - if: github.event_name == 'pull_request_target'
        name: Test pull request üß™ü•º
        run: |
          $ChangedFiles = '${{ steps.changed-files.outputs.all_changed_files }}' | ConvertFrom-Json
          .\WinGetAutomation.ps1 -FormulaToTest $ChangedFiles -PrNo ${{ github.event.number }}
        env:
          BOT_PVT_KEY: ${{ secrets.BOT_PRIVATE_KEY }}
          BOT_APP_ID: ${{ secrets.BOT_APP_ID }}
          BOT_INST_ID: ${{ secrets.BOT_INST_ID }}

      - name: Run tests üß™
        run: |
          $container = New-PesterContainer -Path .\
          $PesterPreference = [PesterConfiguration]::Default
          $PesterPreference.Run.Container = $container
          $PesterPreference.CodeCoverage.Enabled = $false
          $PesterPreference.Output.Verbosity = 'Detailed'
          Invoke-Pester -Configuration $PesterPreference
